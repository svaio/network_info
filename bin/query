#!/bin/bash

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

cd $DIR/../

# Validate input to prevent SQL injection
# Accept IPv4, IPv6, or CIDR notation only
IP_REGEX='^([0-9]{1,3}\.){3}[0-9]{1,3}(/[0-9]{1,2})?$|^([0-9a-fA-F]{0,4}:){1,7}[0-9a-fA-F]{0,4}(/[0-9]{1,3})?$|^::([0-9a-fA-F]{1,4}:){0,5}[0-9a-fA-F]{1,4}(/[0-9]{1,3})?$|^([0-9a-fA-F]{1,4}:){1,5}:([0-9a-fA-F]{1,4}:){0,4}[0-9a-fA-F]{1,4}(/[0-9]{1,3})?$'

if [[ -z "$1" ]]; then
  echo "Usage: $0 <ip-address>"
  echo "Example: $0 8.8.8.8"
  echo "Example: $0 2001:db8::1"
  exit 1
fi

if ! [[ "$1" =~ $IP_REGEX ]]; then
  echo "Error: Invalid IP address format"
  echo "Please provide a valid IPv4 or IPv6 address"
  exit 1
fi

# Load environment variables from .env if it exists
if [ -f "$DIR/../.env" ]; then
  set -a
  . "$DIR/../.env"
  set +a
fi

docker compose run -e PGPASSWORD="${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}" --entrypoint=psql db -h db -U "${POSTGRES_USER:-network_info}" -e -q -x -c "SELECT block.inetnum, block.netname, block.country, block.description, block.maintained_by, block.created, block.last_modified, block.source FROM block WHERE block.inetnum >> '$1' ORDER BY block.inetnum DESC;" "${POSTGRES_DB:-network_info}"
